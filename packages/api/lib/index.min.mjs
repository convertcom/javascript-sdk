/*!
 * Convert JS SDK
 * Version 1.0.0
 * Copyright(c) 2020-2022 Convert Insights, Inc
 * License Apache-2.0
 */
import{SystemEvents as e}from"@convertcom/enums";import{objectDeepValue as t,HttpClient as i}from"@convertcom/utils";function s(e,t,i,s){return new(i||(i=Promise))((function(n,r){function a(e){try{u(s.next(e))}catch(e){r(e)}}function o(e){try{u(s.throw(e))}catch(e){r(e)}}function u(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(a,o)}u((s=s.apply(e,t||[])).next())}))}const n=process.env.CONFIG_ENDPOINT||"https://cdn-4.convertexperiments.com/api/v1/",r=process.env.TRACK_ENDPOINT||"https://[project_id].metrics.convertexperiments.com/v1/",a={"Content-type":"application/json"};class o{constructor(e,{eventManager:i,loggerManager:s}={}){var o,u,c;this._configEndpoint=n,this._trackEndpoint=r,this._defaultHeaders=a,this.batchSize=10,this.releaseInterval=1e4,this._loggerManager=s,this._eventManager=i,this._configEndpoint=t(e,"api.endpoint.config",n),this._trackEndpoint=t(e,"api.endpoint.track",r),this._data=t(e,"data"),this._enrichData=!(null==e?void 0:e.dataStore),this.batchSize=Number(t(e,"events.batch_size")).valueOf()||10,this.releaseInterval=Number(t(e,"events.release_interval")).valueOf()||1e4,this._accountId=null===(o=this._data)||void 0===o?void 0:o.account_id,this._projectId=null===(c=null===(u=this._data)||void 0===u?void 0:u.project)||void 0===c?void 0:c.id,this._trackingEvent={enrichData:this._enrichData,accountId:this._accountId,projectId:this._projectId,visitors:[]},this._requestsQueue={length:0,items:[],push(e,t,i){const s=this.items.findIndex((t=>t.visitorId===e));if(-1!==s)this.items[s].events.push(t);else{const s={visitorId:e,events:[t]};i&&(s.segments=i),this.items.push(s)}this.length++},reset(){this.items=[],this.length=0}}}request(e,t,n={},r={}){return s(this,void 0,void 0,(function*(){const s=Object.assign(Object.assign({},this._defaultHeaders),r),a={method:e,path:t.route,baseURL:t.base,headers:s,data:n,responseType:"json"};return i.request(a)}))}enqueue(e,t,i){var s,n;null===(n=null===(s=this._loggerManager)||void 0===s?void 0:s.trace)||void 0===n||n.call(s,"ApiManager.enqueue()",{eventRequest:t}),this._requestsQueue.push(e,t,i),this._requestsQueue.length===this.batchSize?this.releaseQueue("size").then():1===this._requestsQueue.length&&this.startQueue()}releaseQueue(t){var i,s;null===(s=null===(i=this._loggerManager)||void 0===i?void 0:i.trace)||void 0===s||s.call(i,"ApiManager.releaseQueue()",{reason:t||""}),this.stopQueue();const n=this._trackingEvent;return n.visitors=this._requestsQueue.items.slice(),this.request("post",{base:this._trackEndpoint.replace("[project_id]",this._projectId.toString()),route:`/track/${this._accountId}/${this._projectId}`},n).then((i=>{var s,n;this._requestsQueue.reset(),null===(n=null===(s=this._eventManager)||void 0===s?void 0:s.fire)||void 0===n||n.call(s,e.API_QUEUE_RELEASED,{reason:t,result:i})})).catch((i=>{var s,n,r,a;null===(n=null===(s=this._loggerManager)||void 0===s?void 0:s.error)||void 0===n||n.call(s,"ApiManager.releaseQueue()",{error:i.message}),this.startQueue(),null===(a=null===(r=this._eventManager)||void 0===r?void 0:r.fire)||void 0===a||a.call(r,e.API_QUEUE_RELEASED,{reason:t},i)}))}stopQueue(){clearTimeout(this._requestsQueueTimerID)}startQueue(){this._requestsQueueTimerID=setTimeout((()=>{this.releaseQueue("timeout")}),this.releaseInterval)}setData(e){var t;this._data=e,this._accountId=null==e?void 0:e.account_id,this._projectId=null===(t=null==e?void 0:e.project)||void 0===t?void 0:t.id,this._trackingEvent.accountId=this._accountId,this._trackingEvent.projectId=this._projectId}getConfigByKey(e){var t,i;return null===(i=null===(t=this._loggerManager)||void 0===t?void 0:t.trace)||void 0===i||i.call(t,"ApiManager.getConfigByKey()",{sdkKey:e}),new Promise(((t,i)=>{this.request("get",{base:this._configEndpoint,route:`/config/${e}`}).then((({data:e})=>t(e))).catch(i)}))}}export{o as ApiManager};
//# sourceMappingURL=index.min.mjs.map

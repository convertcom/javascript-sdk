/*!
 * Convert JS SDK
 * Version 1.0.0
 * Copyright(c) 2020-2022 Convert Insights, Inc
 * License Apache-2.0
 */
"use strict";var e=require("@convertcom/js-sdk-enums"),t=require("@convertcom/js-sdk-utils");function s(e,t,s,i){return new(s||(s=Promise))((function(n,r){function a(e){try{u(i.next(e))}catch(e){r(e)}}function o(e){try{u(i.throw(e))}catch(e){r(e)}}function u(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(a,o)}u((i=i.apply(e,t||[])).next())}))}"function"==typeof SuppressedError&&SuppressedError;const i=process.env.CONFIG_ENDPOINT||"https://cdn-4.convertexperiments.com/api/v1/",n=process.env.TRACK_ENDPOINT||"https://[project_id].metrics.convertexperiments.com/v1/",r={"Content-type":"application/json"};exports.ApiManager=class{constructor(e,{eventManager:s,loggerManager:a}={}){var o,u,c;this._configEndpoint=i,this._trackEndpoint=n,this._defaultHeaders=r,this.batchSize=10,this.releaseInterval=1e4,this._loggerManager=a,this._eventManager=s,this._configEndpoint=t.objectDeepValue(e,"api.endpoint.config",i),this._trackEndpoint=t.objectDeepValue(e,"api.endpoint.track",n),this._data=t.objectDeepValue(e,"data"),this._enrichData=!(null==e?void 0:e.dataStore),this.batchSize=Number(t.objectDeepValue(e,"events.batch_size")).valueOf()||10,this.releaseInterval=Number(t.objectDeepValue(e,"events.release_interval")).valueOf()||1e4,this._accountId=null===(o=this._data)||void 0===o?void 0:o.account_id,this._projectId=null===(c=null===(u=this._data)||void 0===u?void 0:u.project)||void 0===c?void 0:c.id,this._trackingEvent={enrichData:this._enrichData,accountId:this._accountId,projectId:this._projectId,visitors:[]},this._requestsQueue={length:0,items:[],push(e,t,s){const i=this.items.findIndex((t=>t.visitorId===e));if(-1!==i)this.items[i].events.push(t);else{const i={visitorId:e,events:[t]};s&&(i.segments=s),this.items.push(i)}this.length++},reset(){this.items=[],this.length=0}}}request(e,i,n={},r={}){return s(this,void 0,void 0,(function*(){const s=Object.assign(Object.assign({},this._defaultHeaders),r),a={method:e,path:i.route,baseURL:i.base,headers:s,data:n,responseType:"json"};return t.HttpClient.request(a)}))}enqueue(e,t,s){var i,n;null===(n=null===(i=this._loggerManager)||void 0===i?void 0:i.trace)||void 0===n||n.call(i,"ApiManager.enqueue()",{eventRequest:t}),this._requestsQueue.push(e,t,s),this._requestsQueue.length===this.batchSize?this.releaseQueue("size").then():1===this._requestsQueue.length&&this.startQueue()}releaseQueue(t){var s,i;null===(i=null===(s=this._loggerManager)||void 0===s?void 0:s.trace)||void 0===i||i.call(s,"ApiManager.releaseQueue()",{reason:t||""}),this.stopQueue();const n=this._trackingEvent;return n.visitors=this._requestsQueue.items.slice(),this.request("post",{base:this._trackEndpoint.replace("[project_id]",this._projectId.toString()),route:`/track/${this._accountId}/${this._projectId}`},n).then((s=>{var i,n;this._requestsQueue.reset(),null===(n=null===(i=this._eventManager)||void 0===i?void 0:i.fire)||void 0===n||n.call(i,e.SystemEvents.API_QUEUE_RELEASED,{reason:t,result:s})})).catch((s=>{var i,n,r,a;null===(n=null===(i=this._loggerManager)||void 0===i?void 0:i.error)||void 0===n||n.call(i,"ApiManager.releaseQueue()",{error:s.message}),this.startQueue(),null===(a=null===(r=this._eventManager)||void 0===r?void 0:r.fire)||void 0===a||a.call(r,e.SystemEvents.API_QUEUE_RELEASED,{reason:t},s)}))}stopQueue(){clearTimeout(this._requestsQueueTimerID)}startQueue(){this._requestsQueueTimerID=setTimeout((()=>{this.releaseQueue("timeout")}),this.releaseInterval)}setData(e){var t;this._data=e,this._accountId=null==e?void 0:e.account_id,this._projectId=null===(t=null==e?void 0:e.project)||void 0===t?void 0:t.id,this._trackingEvent.accountId=this._accountId,this._trackingEvent.projectId=this._projectId}getConfigByKey(e){var t,s;return null===(s=null===(t=this._loggerManager)||void 0===t?void 0:t.trace)||void 0===s||s.call(t,"ApiManager.getConfigByKey()",{sdkKey:e}),new Promise(((t,s)=>{this.request("get",{base:this._configEndpoint,route:`/config/${e}`}).then((({data:e})=>t(e))).catch(s)}))}};
//# sourceMappingURL=index.min.js.map

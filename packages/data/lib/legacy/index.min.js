/*!
 * Convert JS SDK
 * Version 1.0.0
 * Copyright(c) 2020-2022 Convert Insights, Inc
 * License Apache-2.0
 */
"use strict";var e=require("@convertcom/utils"),t=require("@convertcom/enums"),i=function(){return i=Object.assign||function(e){for(var t,i=1,r=arguments.length;i<r;i++)for(var n in t=arguments[i])Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e},i.apply(this,arguments)};function r(e,t){var i="function"==typeof Symbol&&e[Symbol.iterator];if(!i)return e;var r,n,o=i.call(e),a=[];try{for(;(void 0===t||t-- >0)&&!(r=o.next()).done;)a.push(r.value)}catch(e){n={error:e}}finally{try{r&&!r.done&&(i=o.return)&&i.call(o)}finally{if(n)throw n.error}}return a}var n=function(){function i(e,t){var i=void 0===t?{}:t,r=i.dataStore,n=i.eventManager,o=i.loggerManager;this.batchSize=1,this.releaseInterval=5e3,this._loggerManager=o,this._eventManager=n,this.batchSize=1,this.releaseInterval=5e3,this.dataStore=r,this._requestsQueue={}}return i.prototype.set=function(e,t){var i,r,n,o;try{null===(r=null===(i=this.dataStore)||void 0===i?void 0:i.set)||void 0===r||r.call(i,e,t)}catch(e){null===(o=null===(n=this._loggerManager)||void 0===n?void 0:n.error)||void 0===o||o.call(n,"DataStoreManager.set()",{error:e.message})}},i.prototype.get=function(e){var t,i,r,n;try{return null===(i=null===(t=this.dataStore)||void 0===t?void 0:t.get)||void 0===i?void 0:i.call(t,e)}catch(e){null===(n=null===(r=this._loggerManager)||void 0===r?void 0:r.error)||void 0===n||n.call(r,"DataStoreManager.get()",{error:e.message})}return null},i.prototype.enqueue=function(t,i){var r,n;null===(n=null===(r=this._loggerManager)||void 0===r?void 0:r.trace)||void 0===n||n.call(r,"DataStoreManager.enqueue()",{key:t,data:i});var o={};o[t]=i,this._requestsQueue=e.objectDeepMerge(this._requestsQueue,o),Object.keys(this._requestsQueue).length>=this.batchSize?this.releaseQueue("size"):1===Object.keys(this._requestsQueue).length&&this.startQueue()},i.prototype.releaseQueue=function(e){var i,r,n,o;for(var a in null===(r=null===(i=this._loggerManager)||void 0===i?void 0:i.trace)||void 0===r||r.call(i,"DataStoreManager.releaseQueue()",{reason:e||""}),this.stopQueue(),this._requestsQueue)this.set(a,this._requestsQueue[a]);null===(o=null===(n=this._eventManager)||void 0===n?void 0:n.fire)||void 0===o||o.call(n,t.SystemEvents.DATA_STORE_QUEUE_RELEASED,{reason:e||""})},i.prototype.stopQueue=function(){clearTimeout(this._requestsQueueTimerID)},i.prototype.startQueue=function(){var e=this;this._requestsQueueTimerID=setTimeout((function(){e.releaseQueue("timeout")}),this.releaseInterval)},Object.defineProperty(i.prototype,"dataStore",{get:function(){return this._dataStore},set:function(e){var i,r;this.isValidDataStore(e)?this._dataStore=e:null===(r=null===(i=this._loggerManager)||void 0===i?void 0:i.error)||void 0===r||r.call(i,t.ERROR_MESSAGES.DATA_STORE_NOT_VALID)},enumerable:!1,configurable:!0}),i.prototype.isValidDataStore=function(e){return e&&"object"==typeof e&&"function"==typeof e.get&&"function"==typeof e.set},i}(),o=function(){function o(i,r){var n,o,a,l,u,s=r.bucketingManager,d=r.ruleManager,v=r.eventManager,c=r.apiManager,g=r.loggerManager;this._dataEntities=t.DATA_ENTITIES,this._localStoreLimit=1e4,this._bucketedVisitors=new Map,this._environment=null==i?void 0:i.environment,this._apiManager=c,this._bucketingManager=s,this._ruleManager=d,this._loggerManager=g,this._eventManager=v,this._config=i,this._data=e.objectDeepValue(i,"data"),this._accountId=null===(n=this._data)||void 0===n?void 0:n.account_id,this._projectId=null===(a=null===(o=this._data)||void 0===o?void 0:o.project)||void 0===a?void 0:a.id,this.dataStoreManager=e.objectDeepValue(i,"dataStore"),null===(u=null===(l=this._loggerManager)||void 0===l?void 0:l.trace)||void 0===u||u.call(l,t.MESSAGES.DATA_CONSTRUCTOR,this)}return Object.defineProperty(o.prototype,"data",{get:function(){return this._data},set:function(e){var i,r,n;this.isValidConfigData(e)?(this._data=e,this._accountId=null==e?void 0:e.account_id,this._projectId=null===(i=null==e?void 0:e.project)||void 0===i?void 0:i.id):null===(n=null===(r=this._loggerManager)||void 0===r?void 0:r.error)||void 0===n||n.call(r,t.ERROR_MESSAGES.CONFIG_DATA_NOT_VALID)},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"dataStoreManager",{get:function(){return this._dataStoreManager},set:function(e){this._dataStoreManager=null,this._dataStoreManager=new n(this._config,{dataStore:e,eventManager:this._eventManager,loggerManager:this._loggerManager})},enumerable:!1,configurable:!0}),o.prototype._getBucketingByField=function(e,i,r,n,o,a){var l,u,s,d,v,c,g,h,y,_;void 0===o&&(o="key"),void 0===a&&(a=this._environment),null===(s=null===(u=this._loggerManager)||void 0===u?void 0:u.trace)||void 0===s||s.call(u,"DataManager._getBucketingByField()",{visitorId:e,identity:i,visitorProperties:r,locationProperties:n,identityField:o,environment:a});var p=this._getEntityByField(i,"experiences",o),f=!!this.getEntitiesList("archived_experiences").find((function(e){return(null==p?void 0:p.id)==e})),S=!a||!Array.isArray(null==p?void 0:p.environments)||p.environments.includes(a),M=[];if(p&&!f&&S){var E=!1;if(Array.isArray(null==p?void 0:p.locations)&&p.locations.length){var b=this.getItemsByIds(p.locations,"locations"),I=this.filterMatchedRecordsWithRule(b,n);if((M=I.filter((function(e){return Object.values(t.RuleError).includes(e)}))).length)return M[0];E=Boolean(!n||I.length)}else if((null==p?void 0:p.site_area)&&(E=this._ruleManager.isRuleMatched(n,p.site_area),Object.values(t.RuleError).includes(E)))return E;if(!n||E){var m=void 0,O=void 0,T=[],R=[];if(Array.isArray(null==p?void 0:p.audiences)&&p.audiences.length){if((m=this.getItemsByIds(p.audiences,"audiences")).length&&(M=(T=this.filterMatchedRecordsWithRule(m,r)).filter((function(e){return Object.values(t.RuleError).includes(e)}))).length)return M[0];if((O=this.getItemsByIds(p.audiences,"segments")).length&&(M=(R=this.filterMatchedRecordsWithRule(O,r)).filter((function(e){return Object.values(t.RuleError).includes(e)}))).length)return M[0]}if(!r||R.length||T.length){if((null==p?void 0:p.variations)&&(null===(d=null==p?void 0:p.variations)||void 0===d?void 0:d.length))return this._retrieveBucketing(e,p);null===(c=null===(v=this._loggerManager)||void 0===v?void 0:v.debug)||void 0===c||c.call(v,t.MESSAGES.VARIATIONS_NOT_FOUND,{visitorProperties:r,audiences:m})}else null===(h=null===(g=this._loggerManager)||void 0===g?void 0:g.debug)||void 0===h||h.call(g,t.MESSAGES.RULES_NOT_MATCH,{visitorProperties:r,audiences:m,segmentations:O})}else null===(_=null===(y=this._loggerManager)||void 0===y?void 0:y.debug)||void 0===_||_.call(y,t.MESSAGES.LOCATION_NOT_MATCH,((l={locationProperties:n})[(null==p?void 0:p.locations)?"experiences[].variations[].locations":"experiences[].variations[].site_area"]=(null==p?void 0:p.locations)||(null==p?void 0:p.site_area)||"",l))}return null},o.prototype._retrieveBucketing=function(e,r){var n,o,a,l,u,s,d,v,c,g,h,y;if(!e||!r)return null;if(!(null==r?void 0:r.id))return null;var _=null,p=null,f=this.getStoreKey(e),S=this.getLocalStore(e)||{},M=S.bucketing,E=(void 0===M?{}:M)[r.id.toString()],b=S.segments;if(E&&(_=this.retrieveVariation(r.id,E)))null===(l=null===(a=this._loggerManager)||void 0===a?void 0:a.debug)||void 0===l||l.call(a,t.MESSAGES.BUCKETED_VISITOR_FOUND,{storeKey:f,visitorId:e,variationId:E});else{var I=((null===(s=null===(u=this.dataStoreManager)||void 0===u?void 0:u.get)||void 0===s?void 0:s.call(u,f))||{}).bucketing,m=(void 0===I?{}:I)[r.id.toString()];if(m&&(_=this.retrieveVariation(r.id,m)))this.putLocalStore(e,i({bucketing:(n={},n[r.id.toString()]=m,n)},b?{segments:b}:{})),null===(v=null===(d=this._loggerManager)||void 0===d?void 0:d.debug)||void 0===v||v.call(d,t.MESSAGES.BUCKETED_VISITOR_FOUND,{storeKey:f,visitorId:e,variationId:m});else{var O=r.variations.reduce((function(e,t){return(null==t?void 0:t.id)&&(e[t.id]=(null==t?void 0:t.traffic_allocation)||100),e}),{});if(m=this._bucketingManager.getBucketForVisitor(O,e)){var T=i({bucketing:(o={},o[r.id.toString()]=m,o)},b?{segments:b}:{});this.putLocalStore(e,T),this.dataStoreManager.enqueue(f,T);var R={experienceId:r.id,variationId:m},D={eventType:t.EventType.BUCKETING,data:R};this._apiManager.enqueue(e,D,b),null===(g=null===(c=this._loggerManager)||void 0===c?void 0:c.trace)||void 0===g||g.call(c,"DataManager._retrieveBucketing()",{visitorEvent:D}),_=this.retrieveVariation(r.id,m)}else null===(y=null===(h=this._loggerManager)||void 0===h?void 0:h.error)||void 0===y||y.call(h,t.ERROR_MESSAGES.UNABLE_TO_SELECT_BUCKET_FOR_VISITOR,{visitorId:e,experience:r})}}return _&&(p=i({experienceId:null==r?void 0:r.id,experienceName:null==r?void 0:r.name,experienceKey:null==r?void 0:r.key},_)),p},o.prototype.retrieveVariation=function(e,t){return this.getSubItem("experiences",e,"variations",t,"id","id")},o.prototype.putLocalStore=function(e,t){var i,n,o=this.getStoreKey(e);if(this._bucketedVisitors.set(o,t),this._bucketedVisitors.size>this._localStoreLimit)try{for(var a=function(e){var t="function"==typeof Symbol&&Symbol.iterator,i=t&&e[t],r=0;if(i)return i.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&r>=e.length&&(e=void 0),{value:e&&e[r++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}(this._bucketedVisitors),l=a.next();!l.done;l=a.next()){var u=r(l.value,2),s=u[0];u[1];this._bucketedVisitors.delete(s);break}}catch(e){i={error:e}}finally{try{l&&!l.done&&(n=a.return)&&n.call(a)}finally{if(i)throw i.error}}},o.prototype.getLocalStore=function(e){var t=this.getStoreKey(e);return this._bucketedVisitors.get(t)||null},o.prototype.getStoreKey=function(e){return"".concat(this._accountId,"-").concat(this._projectId,"-").concat(e)},o.prototype.getBucketing=function(e,t,i,r,n){return void 0===n&&(n=this._environment),this._getBucketingByField(e,t,i,r,"key",n)},o.prototype.getBucketingById=function(e,t,i,r,n){return void 0===n&&(n=this._environment),this._getBucketingByField(e,t,i,r,"id",n)},o.prototype.convert=function(e,i,r,n,o){var a,l,u,s,d,v,c="string"==typeof i?this.getEntity(i,"goals"):this.getEntityById(i,"goals");if(null==c?void 0:c.id){if(r){if(!(null==c?void 0:c.rules))return;var g=this._ruleManager.isRuleMatched(r,c.rules);if(Object.values(t.RuleError).includes(g))return g;if(!g)return void(null===(s=null===(u=this._loggerManager)||void 0===u?void 0:u.error)||void 0===s||s.call(u,t.MESSAGES.GOAL_RULE_NOT_MATCH))}var h={goalId:c.id},y=(this.getLocalStore(e)||{}).bucketing;y&&(h.bucketingData=y);var _={eventType:t.EventType.CONVERSION,data:h};if(this._apiManager.enqueue(e,_,o),n){var p={goalId:c.id,goalData:n};y&&(p.bucketingData=y);var f={eventType:t.EventType.CONVERSION,data:p};this._apiManager.enqueue(e,f,o)}null===(v=null===(d=this._loggerManager)||void 0===d?void 0:d.trace)||void 0===v||v.call(d,"DataManager.convert()",{event:_})}else null===(l=null===(a=this._loggerManager)||void 0===a?void 0:a.error)||void 0===l||l.call(a,t.MESSAGES.GOAL_NOT_FOUND)},o.prototype.filterMatchedRecordsWithRule=function(t,i){var r,n,o,a,l;null===(n=null===(r=this._loggerManager)||void 0===r?void 0:r.trace)||void 0===n||n.call(r,"DataManager.filterMatchedRecordsWithRule()",{items:t,visitorProperties:i});var u,s=[];if(e.arrayNotEmpty(t))for(var d=0,v=t.length;d<v;d++)(null===(o=null==t?void 0:t[d])||void 0===o?void 0:o.rules)&&(!0===(u=this._ruleManager.isRuleMatched(i,t[d].rules))?s.push(t[d]):!1!==u&&s.push(u));return null===(l=null===(a=this._loggerManager)||void 0===a?void 0:a.debug)||void 0===l||l.call(a,"DataManager.filterMatchedRecordsWithRule()",{matchedRecords:s}),s},o.prototype.getEntitiesList=function(t){var i,r,n=[];return-1!==this._dataEntities.indexOf(t)&&(n=e.objectDeepValue(this._data,t)||[]),null===(r=null===(i=this._loggerManager)||void 0===i?void 0:i.trace)||void 0===r||r.call(i,"DataManager.getEntitiesList()",{entityType:t,list:n}),n},o.prototype.getEntitiesListObject=function(e,t){return void 0===t&&(t="id"),this.getEntitiesList(e).reduce((function(e,i){return e[i[t]]=i,e}),{})},o.prototype._getEntityByField=function(t,i,r){var n,o,a;void 0===r&&(r="key"),null===(o=null===(n=this._loggerManager)||void 0===n?void 0:n.trace)||void 0===o||o.call(n,"DataManager._getEntityByField()",{identity:t,entityType:i,identityField:r});var l=this.getEntitiesList(i);if(e.arrayNotEmpty(l))for(var u=0,s=l.length;u<s;u++)if(l[u]&&(null===(a=l[u])||void 0===a?void 0:a[r])===t)return l[u];return null},o.prototype.getEntity=function(e,t){return this._getEntityByField(e,t,"key")},o.prototype.getEntities=function(e,t){return this.getItemsByKeys(e,t)},o.prototype.getEntityById=function(e,t){return this._getEntityByField(e,t,"id")},o.prototype.getEntitiesByIds=function(e,t){return this.getItemsByIds(e,t)},o.prototype.getItemsByKeys=function(t,i){var r,n=this.getEntitiesList(i),o=[];if(e.arrayNotEmpty(n))for(var a=0,l=n.length;a<l;a++)-1!==t.indexOf(null===(r=n[a])||void 0===r?void 0:r.key)&&o.push(n[a]);return o},o.prototype.getItemsByIds=function(t,i){var r,n,o;null===(n=null===(r=this._loggerManager)||void 0===r?void 0:r.trace)||void 0===n||n.call(r,"DataManager.getItemsByIds()",{ids:t,path:i});var a=[];if(e.arrayNotEmpty(t)){var l=this.getEntitiesList(i);if(e.arrayNotEmpty(l))for(var u=0,s=l.length;u<s;u++)-1!==t.indexOf(null===(o=l[u])||void 0===o?void 0:o.id)&&a.push(l[u])}return a},o.prototype.getSubItem=function(e,t,i,r,n,o){var a,l=this._getEntityByField(t,e,n);for(var u in l[i])if((null===(a=l[i][u])||void 0===a?void 0:a[o])==r)return l[i][u];return null},o.prototype.isValidConfigData=function(t){var i;return e.objectNotEmpty(t)&&!!(null==t?void 0:t.account_id)&&!!(null===(i=null==t?void 0:t.project)||void 0===i?void 0:i.id)},o}();exports.DataManager=o,exports.DataStoreManager=n;
//# sourceMappingURL=index.min.js.map
